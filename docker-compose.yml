services:
  php72:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION:-7.2}
    container_name: php72
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ~/.ssh:/root/.ssh:ro
      - ${WEB_ROOT}:/var/www:cached
      - ${COMPOSER}/php72:/root/.composer:cached
      - ${PHP72_INI}:/usr/local/etc/php/php.ini:ro
    environment:
      TZ: ${TZ:-Asia/Shanghai}
      WEB_ENV: ${WEB_ENV:-local}
    ports:
      - "${PHP_PORT:-4000}:4000"
    extra_hosts:
      - fund-api.test:172.20.128.2
      - fund-system.test:172.20.128.2
      - xyf-pay-system.test:172.20.128.2
      - shoufuyou-pay-gateway.test:172.20.128.2
      - xyf-middleground-system.test:172.20.128.2
    networks:
      static-network:
        ipv4_address: 172.20.128.3

  nginx:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: nginx
    restart: unless-stopped
    volumes:
      - ${WEB_ROOT}:/var/www:cached
      - ${NGINX_CONF}:/etc/nginx/conf.d:ro
      - ${LOG}/nginx:/var/log/nginx:cached
    ports:
      - "${NGINX_PORT:-80}:80"
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    depends_on:
      - php72
    networks:
      static-network:
        ipv4_address: 172.20.128.2

  mysql:
    image: mysql:${MYSQL_VERSION:-8.0}
    container_name: mysql
    restart: unless-stopped
    volumes:
      - ${MYSQL_DATA}:/var/lib/mysql:cached
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_USER: ${MYSQL_USER:-homestead}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-secret}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-homestead}
      TZ: ${TZ:-Asia/Shanghai}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    # MySQL 8.0 镜像支持 ARM64 架构
    networks:
      static-network:
        ipv4_address: 172.20.128.4

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: redis
    restart: unless-stopped
    volumes:
      - ${REDIS_DATA}:/data:cached
      - ${REDIS_CONF}:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      static-network:
        ipv4_address: 172.20.128.5

  sftp:
    image: atmoz/sftp:${SFTP_VERSION:-latest}
    container_name: sftp
    restart: unless-stopped
    volumes:
      - ${SFTP_DIR}:/home/${SFTP_USER:-foo}:cached
    ports:
      - "${SFTP_PORT:-2222}:22"
    command: ${SFTP_USER:-foo}:${SFTP_PASSWORD:-pass}:1001:1001
    networks:
      static-network:
        ipv4_address: 172.20.128.6

  rmq:
    image: rabbitmq:${RMQ_VERSION:-3-management-alpine}
    container_name: rmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RMQ_PASSWORD:-guest}
      TZ: ${TZ:-Asia/Shanghai}
    ports:
      - "${RMQ_WEB_PORT:-15672}:15672"
      - "${RMQ_PORT:-5672}:5672"
    networks:
      static-network:
        ipv4_address: 172.20.128.7

networks:
  static-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16